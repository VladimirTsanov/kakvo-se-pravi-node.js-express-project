<!DOCTYPE html>
<html lang="bg">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Админ панел - Добавяне на статия</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/quill@2.0.3/dist/quill.snow.css">
</head>

<body>
    <h1>Добавяне на статия</h1>

    <label for="">Заглавие на статия: </label>
    <input type="text" id="title" placeholder="Заглавие" onkeyup="convertToSlug()"><br>

    <label for="">Slug: </label>
    <input type="text" id="slug" value="" readonly="readonly"><br>

    <label for="">Избери категория: </label>
    <select name="category" id="category" onchange="autoFindCategorySlug()">
        <option value="" disabled selected>Изберете опция</option>
        <% allCategories.forEach((item) => { %>
            <option value="<%- item.slug %>"><%- item.name %></option>
        <% }) %>
    </select><br>
    
    <label for="">Slug на категорията: </label>
    <input type="text" id="categorySlug" readonly="readonly"><br>

    <div id="editor" style="height: 200px;"></div><br>

    <button id="submitBtn">Запази</button>

    <script src="https://cdn.jsdelivr.net/npm/quill@2.0.3/dist/quill.js"></script>
    <script>
        const quill = new Quill('#editor', { theme: 'snow' });


        function autoFindCategorySlug() {
            const selectedText = document.getElementById("category").value;

            if (selectedText) {
                document.getElementById("categorySlug").value = selectedText;
            } else {
                document.getElementById("categorySlug").value = '';
            }
        }

        function transliterate(text) {
            const cyrillicToLatinMap = {
                'а': 'a', 'б': 'b', 'в': 'v', 'г': 'g',
                'д': 'd', 'е': 'e', 'ж': 'zh', 'з': 'z',
                'и': 'i', 'й': 'y', 'к': 'k', 'л': 'l',
                'м': 'm', 'н': 'n', 'о': 'o', 'п': 'p',
                'р': 'r', 'с': 's', 'т': 't', 'у': 'u',
                'ф': 'f', 'х': 'h', 'ц': 'ts', 'ч': 'ch',
                'ш': 'sh', 'щ': 'sht', 'ъ': 'a', 'ь': '',
                'ю': 'yu', 'я': 'ya',

                'А': 'A', 'Б': 'B', 'В': 'V', 'Г': 'G',
                'Д': 'D', 'Е': 'E', 'Ж': 'Zh', 'З': 'Z',
                'И': 'I', 'Й': 'Y', 'К': 'K', 'Л': 'L',
                'М': 'M', 'Н': 'N', 'О': 'O', 'П': 'P',
                'Р': 'R', 'С': 'S', 'Т': 'T', 'У': 'U',
                'Ф': 'F', 'Х': 'H', 'Ц': 'Ts', 'Ч': 'Ch',
                'Ш': 'Sh', 'Щ': 'Sht', 'Ъ': 'A', 'Ь': '',
                'Ю': 'Yu', 'Я': 'Ya'
            };

            return text.split('').map(char => cyrillicToLatinMap[char] || char).join('');
        }


        function convertToSlug() {
            const title = document.getElementById("title").value;

            const slug = transliterate(title)
                .toLowerCase()
                .replace(/[^a-z0-9\s-]/g, '')
                .trim()
                .replace(/\s+/g, '-');
            document.getElementById("slug").value = slug;
        }


        document.getElementById("submitBtn").addEventListener('click', () => {
            const title = document.getElementById('title').value;
            const slug = document.getElementById('slug').value;
            const categorySlug = document.getElementById('categorySlug').value;
            const content = quill.root.innerHTML;
            
            fetch('http://localhost:3000/admin', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ title, slug, categorySlug, content })
            })
                .then(res => res.json())
                .then(data => {
                    alert(data.message);
                    document.getElementById('title').value = '';
                    document.getElementById('slug').value = '';
                    document.getElementById('categorySlug').value = '';
                    quill.root.innerHTML = '';
                })
                .catch(err => console.error(err));
        });

    </script>

</body>

</html>